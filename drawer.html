<!DOCTYPE html>
<html>
<head>
<title></title>
<!-- 2017-10-19 Thu 00:31 -->
<meta  charset="utf-8" />
<meta  htto-equiv="X-UA-Compatible" content="chrome=1" />
<meta  name="generator" content="Org-mode with org-ioslide" />
<meta  name="author" content="raynoldng" />


<!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
<!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--This one seems to work all the time, but really small on ipad-->
<!--<meta name="viewport" content="initial-scale=0.4">-->
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="stylesheet" media="all" href="theme/css/default.css" />
<link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="theme/css/phone.css" />
<link rel="stylesheet" media="all" href="theme/css/small-icon.css" />
<base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
<script data-main="js/slides" src="js/require-1.0.8.min.js"></script>

   <script src="js/jquery-1.7.1.min.js" type="text/javascript"></script>

<script src="js/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML,local/local" type="text/javascript"></script>
</head>
<body style="opacity: 0">
<slides class="layout-widescreen">
<slide class="title-slide segue nobackground">
       <aside class="gdbar"><img src="images/emacs-icon.png"></aside>
       <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
       <hgroup class="auto-fadein">
         <h1 data-config-title><!-- populated from slide_config.json --></h1>
         <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
         <p data-config-presenter><!-- populated from slide_config.json --></p>
       </hgroup>
    </slide>
  <p>
import pygame
from pygame.locals import *
import sys, os
import time
from PIL import Image, ImageFilter
</p>

<p>
from tensorflow.examples.tutorials.mnist import input<sub>data</sub>
import tensorflow as tf
import cv2
</p>

<p>
pygame.init()
mouse = pygame.mouse
fpsClock = pygame.time.Clock()
width = 280
height = 280
</p>

<p>
window = pygame.display.set<sub>mode</sub>((width, height))
canvas = window.copy()
</p>

<p>
BLACK = pygame.Color( 0 ,  0 ,  0 )
WHITE = pygame.Color(255, 255, 255)
</p>

<p>
pygame.display.set<sub>caption</sub>('Paintme')
</p>


<p>
def imageprepare(argv):
    """
    This function returns the pixel values.
    The imput is a png file location.
    """
    im = Image.open(argv).convert('L')
    width = float(im.size[0])
    height = float(im.size[1])
    newImage = Image.new('L', (28, 28), (255)) #creates white canvas of 28x28 pixels
</p>

<p>
if width &gt; height: #check which dimension is bigger
    #Width is bigger. Width becomes 20 pixels.
    nheight = int(round((20.0/width*height),0)) #resize height according to ratio width
    if (nheight == 0): #rare case but minimum is 1 pixel
        nheight = 1
</p>

<p>
    img = im.resize((20,nheight), Image.ANTIALIAS).filter(ImageFilter.SHARPEN)
    wtop = int(round(((28 - nheight)/2),0)) #caculate horizontal pozition
    newImage.paste(img, (4, wtop)) #paste resized image on white canvas
else:
    #Height is bigger. Heigth becomes 20 pixels. 
    nwidth = int(round((20.0/height*width),0)) #resize width according to ratio height
    if (nwidth == 0): #rare case but minimum is 1 pixel
        nwidth = 1
</p>

<p>
img = im.resize((nwidth,20), Image.ANTIALIAS).filter(ImageFilter.SHARPEN)
wleft = int(round(((28 - nwidth)/2),0)) #caculate vertical pozition
newImage.paste(img, (wleft, 4)) #paste resized image on white canvas
</p>

<p>
tv = list(newImage.getdata()) #get pixel values
</p>

<p>
#normalize pixels to 0 and 1. 0 is pure white, 1 is pure black.
tva = [ (255-x)*1.0/255.0 for x in tv] 
return tva
</p>

<p>
sess = tf.Session()
</p>

<p>
x = tf.placeholder(tf.float32, [None, 784])
</p>

<p>
y_ = tf.placeholder(tf.float32, [None, 10])
def weight<sub>variable</sub>(shape):
    initial = tf.truncated<sub>normal</sub>(shape, stddev=0.1)
    return tf.Variable(initial)
</p>

<p>
def bias<sub>variable</sub>(shape):
    initial = tf.constant(0.1, shape=shape)
    return tf.Variable(initial)
</p>

<p>
def conv2d(x, W):
    return tf.nn.conv2d(x, W, strides=[1, 1, 1, 1], padding='SAME')
</p>

<p>
def max<sub>pool</sub><sub>2x2</sub>(x):
    return tf.nn.max<sub>pool</sub>(x, ksize=[1, 2, 2, 1],
                            strides=[1, 2, 2, 1], padding='SAME')
</p>

<p>
W<sub>conv1</sub> = weight<sub>variable</sub>([5, 5, 1, 32])
b<sub>conv1</sub> = bias<sub>variable</sub>([32])
x<sub>image</sub> = tf.reshape(x, [-1, 28, 28, 1])
h<sub>conv1</sub> = tf.nn.relu(conv2d(x<sub>image</sub>, W<sub>conv1</sub>) + b<sub>conv1</sub>)
h<sub>pool1</sub> = max<sub>pool</sub><sub>2x2</sub>(h<sub>conv1</sub>)
</p>

<p>
W<sub>conv2</sub> = weight<sub>variable</sub>([5, 5, 32, 64])
b<sub>conv2</sub> = bias<sub>variable</sub>([64])
</p>

<p>
h<sub>conv2</sub> = tf.nn.relu(conv2d(h<sub>pool1</sub>, W<sub>conv2</sub>) + b<sub>conv2</sub>)
h<sub>pool2</sub> = max<sub>pool</sub><sub>2x2</sub>(h<sub>conv2</sub>)
</p>

<p>
W<sub>fc1</sub> = weight<sub>variable</sub>([7 * 7 * 64, 1024])
b<sub>fc1</sub> = bias<sub>variable</sub>([1024])
</p>

<p>
h<sub>pool2</sub><sub>flat</sub> = tf.reshape(h<sub>pool2</sub>, [-1, 7*7*64])
h<sub>fc1</sub> = tf.nn.relu(tf.matmul(h<sub>pool2</sub><sub>flat</sub>, W<sub>fc1</sub>) + b<sub>fc1</sub>)
</p>

<p>
keep<sub>prob</sub> = tf.placeholder(tf.float32)
</p>

<p>
h<sub>fc1</sub><sub>drop</sub> = h<sub>fc1</sub>
</p>

<p>
W<sub>fc2</sub> = weight<sub>variable</sub>([1024, 10])
b<sub>fc2</sub> = bias<sub>variable</sub>([10])
</p>

<p>
y<sub>conv</sub> = tf.matmul(h<sub>fc1</sub><sub>drop</sub>, W<sub>fc2</sub>) + b<sub>fc2</sub>
predict<sub>op</sub> = tf.argmax(y<sub>conv</sub>, 1)
</p>

<p>
saver = tf.train.Saver()
model<sub>path</sub> = "./tmp/model.ckpt"
</p>

<p>
def predict(image<sub>path</sub>):
</p>

<p>
im = cv2.imread("screenshot.png")
</p>

<p>
temp = im.reshape(28*28, 3)
im = [1-i[0]/255 for i in temp]
</p>

<p>
with sess.as<sub>default</sub>():
    sess.run(tf.global<sub>variables</sub><sub>initializer</sub>())
    saver.restore(sess, model<sub>path</sub>)
    result = sess.run(predict<sub>op</sub>, {x: [im]})
    return result
</p>


<p>
def resize(img<sub>path</sub>):
    im = Image.open(img<sub>path</sub>)
    im = im.resize((28, 28))
    im.save(img<sub>path</sub>, "png")
</p>

<p>
canvas.fill(WHITE)
window.blit(canvas, (0, 0))
window.fill(WHITE)
</p>

<p>
myfont = pygame.font.SysFont("monospace", 16)
predicted<sub>digit</sub> = -1
scoretext = myfont.render("Predicted: " + str(predicted<sub>digit</sub>), 1, (0,0,0))
canvas.blit(scoretext, (5, 10))
</p>

<p>
while True:
    for event in pygame.event.get():
        left<sub>pressed</sub>, middle<sub>pressed</sub>, right<sub>pressed</sub> = pygame.mouse.get<sub>pressed</sub>()
        if event.type == QUIT:
            pygame.quit()
            sys.exit()
        elif left<sub>pressed</sub>:
            pygame.draw.rect(window, BLACK, pygame.mouse.get<sub>pos</sub>()+(10,10),10)
</p>

<p>
elif right<sub>pressed</sub>:
    print("saving image")
    image<sub>path</sub> = "screenshot.png"
    pygame.image.save(window, image<sub>path</sub>)
    resize(image<sub>path</sub>)
    predicted<sub>digit</sub> = predict(image<sub>path</sub>)
    print("updating text to {}" % predicted<sub>digit</sub>)
</p>


<p>
elif event.type <code>= pygame.KEYDOWN and event.key =</code> pygame.K<sub>RETURN</sub>:
    window.fill(WHITE)
pygame.display.update()
</p>
<slide class="backdrop"></slide>
</slides> 
<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body> 

</html>
